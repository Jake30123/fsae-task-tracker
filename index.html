<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FSAE Fabrication Tracker - v3.0</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDK (Compat for simple script usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Project Config -->
    <script src="firebase-config.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f4;
            /* Stone-100 */
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #d6d3d1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a29e;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            height: 250px;
            max-height: 300px;
        }

        /* Modal Transition */
        .modal {
            transition: opacity 0.25s ease;
        }

        body.modal-active {
            overflow: hidden;
        }

        /* Status Pills (Read Only) */
        .status-pill-completed {
            @apply bg-emerald-100 text-emerald-800 border-emerald-200;
        }

        .status-pill-progress {
            @apply bg-amber-100 text-amber-800 border-amber-200;
        }

        .status-pill-todo {
            @apply bg-stone-100 text-stone-600 border-stone-200;
        }

        /* Interactive Select Pill */
        .select-pill {
            @apply appearance-none border-none text-sm font-bold uppercase tracking-wide px-4 py-1.5 rounded-full cursor-pointer focus:ring-2 focus:ring-offset-1 focus:outline-none text-center;
            text-align-last: center;
            /* Aligns text in some browsers */
        }

        /* Tab Active State */
        .tab-active {
            @apply border-red-500 text-red-600 border-b-2;
        }

        .tab-inactive {
            @apply border-transparent text-stone-500 hover:text-stone-700 hover:border-stone-300 border-b-2;
        }
    </style>
</head>

<body class="text-stone-800 antialiased min-h-screen flex flex-col">

    <!-- ================== LOGIN VIEW ================== -->
    <div id="login-view"
        class="fixed inset-0 z-50 flex items-center justify-center bg-stone-200 bg-opacity-50 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-stone-100">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-stone-800 tracking-tight">Mk VIII Fabrication Tracker</h1>
                <p class="text-stone-500 mt-2 text-sm">Select your profile to begin</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-stone-500 uppercase tracking-wider mb-1">Team
                        Member</label>
                    <input type="text" id="user-input" list="user-list" placeholder="Type your name..."
                        class="w-full p-3 bg-stone-50 border border-stone-200 rounded-lg focus:ring-2 focus:ring-stone-400 focus:outline-none transition-all">
                    <datalist id="user-list">
                        <!-- Populated by JS -->
                    </datalist>
                </div>

                <!-- Role Selection Removed (Handled Automatically) -->
                <div></div>

                <button onclick="app.login()"
                    class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-colors mt-4">
                    Enter
                </button>
            </div>
        </div>
    </div>

    <!-- ================== APP SHELL ================== -->
    <div id="app-shell" class="hidden flex-1 flex flex-col">

        <!-- Navigation -->
        <nav class="bg-white border-b border-stone-200 sticky top-0 z-30 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center gap-4">
                        <div class="flex-shrink-0 flex items-center cursor-pointer" onclick="location.reload()">
                            <span class="text-2xl font-bold text-stone-900 tracking-tighter">Mk VIII <span
                                    class="text-red-600">Fabrication Tracker</span></span>
                        </div>
                        <div class="hidden md:flex ml-6 space-x-4 items-center">
                            <span id="nav-portal-label"
                                class="px-3 py-1 rounded-full text-xs font-medium bg-stone-100 text-stone-600 border border-stone-200">
                                Member Portal
                            </span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right hidden sm:block">
                            <div id="user-display-name" class="text-sm font-medium text-stone-900">User</div>
                            <div id="user-display-subteam" class="text-xs text-stone-500">Mechanical</div>
                        </div>
                        <button onclick="app.logout()" class="text-stone-400 hover:text-red-600 transition-colors">
                            <span class="text-sm font-semibold">Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">

            <!-- MEMBER DASHBOARD -->
            <div id="member-dashboard" class="hidden space-y-8">
                <!-- Welcome / Stats Header -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100 md:col-span-2">
                        <div class="flex justify-between items-start mb-2">
                            <h2 class="text-2xl font-bold text-stone-800">My Fabrication Tasks</h2>
                            <button onclick="app.createNewTask()"
                                class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-sm font-medium shadow-sm transition-colors transform scale-100 hover:scale-105">
                                + Create Task
                            </button>
                        </div>
                        <p class="text-stone-500 mb-6">Track your progress and access drawings.</p>
                        <div class="w-full bg-stone-100 rounded-full h-4 mb-2 overflow-hidden">
                            <div id="member-progress-bar"
                                class="bg-emerald-500 h-4 rounded-full transition-all duration-1000" style="width: 0%">
                            </div>
                        </div>
                        <div class="flex justify-between text-xs font-medium text-stone-500">
                            <span>0% Complete</span>
                            <span id="member-progress-text">0 / 0 Tasks Done</span>
                        </div>
                    </div>
                    <div
                        class="bg-white p-6 rounded-xl shadow-sm border border-stone-100 flex flex-col justify-center items-center text-center">
                        <span class="text-stone-400 text-sm uppercase tracking-wider font-semibold">Pending Tasks</span>
                        <span id="member-pending-count" class="text-5xl font-bold text-stone-800 mt-2">0</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold text-stone-800 flex items-center gap-2">
                                <span class="w-2 h-6 bg-red-600 rounded-full"></span> Assigned to Me
                            </h3>
                        </div>
                        <div id="my-tasks-list" class="space-y-4"></div>
                        <div id="my-tasks-empty"
                            class="hidden p-8 text-center bg-stone-50 rounded-xl border border-dashed border-stone-300 text-stone-400">
                            No tasks currently assigned to you. Check the Open Pool!
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-stone-800 text-white p-4 rounded-t-xl -mb-4 z-10 relative">
                            <h3 class="text-lg font-bold flex items-center gap-2"><span>&#9935;</span> Open Task Pool
                            </h3>
                            <p class="text-stone-400 text-xs">Unassigned tasks ready for pickup</p>
                        </div>
                        <div
                            class="bg-white rounded-xl shadow-sm border border-stone-200 p-4 max-h-[600px] overflow-y-auto">
                            <div id="pool-tasks-list" class="space-y-3 mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LEAD DASHBOARD -->
            <div id="lead-dashboard" class="hidden space-y-8">
                <!-- Lead Tabs -->
                <div class="border-b border-stone-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button onclick="app.switchLeadTab('overview')" id="tab-overview"
                            class="tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                            Overview & Tracking
                        </button>
                        <button onclick="app.switchLeadTab('manage')" id="tab-manage"
                            class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                            Manage Team & Tasks
                        </button>
                    </nav>
                </div>

                <!-- OVERVIEW TAB CONTENT -->
                <div id="lead-content-overview" class="space-y-8">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                            <h4 class="text-sm font-bold text-stone-500 uppercase tracking-wide mb-4">Fabrication Status
                            </h4>
                            <div class="chart-container"><canvas id="teamStatusChart"></canvas></div>
                        </div>

                        <!-- NEW LOCATION: Create Task -->
                        <div
                            class="bg-white p-6 rounded-xl shadow-sm border border-stone-100 flex flex-col justify-center items-center text-center">
                            <div class="mb-4">
                                <h3 class="text-lg font-bold text-stone-900">Create New Task</h3>
                                <p class="text-sm text-stone-500 max-w-xs mx-auto">Add new parts, assemblies, or jobs to
                                    the tracker.</p>
                            </div>
                            <button onclick="app.createNewTask()"
                                class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium shadow-sm transition-colors flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                                    viewBox="0 0 16 16">
                                    <path
                                        d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
                                </svg>
                                <span>Add Task</span>
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden">
                        <div
                            class="p-4 border-b border-stone-200 bg-stone-50 flex flex-col sm:flex-row justify-between items-center gap-4">
                            <h3 class="font-bold text-stone-700">Master Task List</h3>
                            <select id="lead-filter-subteam" class="text-sm border-stone-300 rounded-md shadow-sm"
                                onchange="app.renderLeadDashboard()">
                                <option value="All">All Subteams</option>
                                <option value="General">General</option>
                                <option value="Drivetrain">Drivetrain</option>
                                <option value="Accumulator">Accumulator</option>
                                <option value="Cockpit">Cockpit</option>
                                <option value="Suspension">Suspension</option>
                                <option value="Aero">Aero</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-stone-200">
                                <thead class="bg-stone-50">
                                    <tr>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">
                                            Part / Task</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">
                                            Owner</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">
                                            Subteam</th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">
                                            Status</th>
                                        <th class="relative px-6 py-3"><span class="sr-only">View</span></th>
                                    </tr>
                                </thead>
                                <tbody id="lead-table-body" class="bg-white divide-y divide-stone-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- MANAGE TAB CONTENT -->
                <div id="lead-content-manage" class="hidden space-y-8">

                    <!-- REMOVED Create Task Section (Moved to Overview) -->

                    <!-- NEW LOCATION: Workload Chart -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                        <h4 class="text-lg font-bold text-stone-900 mb-4">Workload by Member</h4>
                        <div class="chart-container" style="height: 300px;"><canvas id="memberWorkloadChart"></canvas>
                        </div>
                    </div>

                    <!-- Team Management Section -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-100">
                        <h3 class="text-lg font-bold text-stone-900 mb-4">Team Roster</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

                            <!-- Add Member Form -->
                            <div class="bg-stone-50 p-4 rounded-lg border border-stone-200">
                                <h4 class="text-sm font-bold text-stone-700 mb-3">Add New Member</h4>
                                <div class="space-y-3">
                                    <input type="text" id="new-member-name" placeholder="Name (e.g. John Doe)"
                                        class="w-full p-2 border border-stone-300 rounded text-sm focus:ring-2 focus:ring-red-500 focus:outline-none">
                                    <select id="new-member-subteam"
                                        class="w-full p-2 border border-stone-300 rounded text-sm bg-white">
                                        <option value="General">General</option>
                                        <option value="Drivetrain">Drivetrain</option>
                                        <option value="Accumulator">Accumulator</option>
                                        <option value="Cockpit">Cockpit</option>
                                        <option value="Suspension">Suspension</option>
                                        <option value="Aero">Aero</option>
                                    </select>
                                    <button onclick="app.addMember()"
                                        class="w-full bg-stone-800 text-white py-2 rounded text-sm font-medium hover:bg-stone-900">Add
                                        Member</button>
                                </div>
                            </div>

                            <!-- Current Roster List -->
                            <div class="border border-stone-200 rounded-lg overflow-hidden">
                                <div
                                    class="bg-stone-100 px-4 py-2 border-b border-stone-200 text-xs font-bold text-stone-500 uppercase">
                                    Current Members</div>
                                <div id="member-roster-list" class="max-h-60 overflow-y-auto divide-y divide-stone-100">
                                    <!-- JS populated -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ================== TASK DETAIL MODAL (VIEW & EDIT) ================== -->
    <div id="task-modal" class="fixed inset-0 z-[100] hidden overflow-y-auto" aria-labelledby="modal-title"
        role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-stone-900 bg-opacity-75 transition-opacity" onclick="app.closeModal()"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

            <div
                class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl w-full">

                <!-- Modal Header -->
                <div class="bg-stone-50 px-4 py-5 sm:px-6 border-b border-stone-200 flex justify-between items-start">
                    <div id="modal-header-read" class="w-full">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-lg leading-6 font-medium text-stone-900" id="modal-title">Part Name</h3>
                                <p class="mt-1 max-w-2xl text-sm text-stone-500" id="modal-subteam">Subteam</p>
                            </div>
                        </div>
                    </div>
                    <div id="modal-header-edit" class="hidden w-full mr-4">
                        <input type="text" id="edit-task-name"
                            class="w-full font-bold text-lg border-b border-stone-300 focus:outline-none focus:border-red-500 bg-transparent"
                            placeholder="Task Name">
                        <div class="flex gap-2 mt-2">
                            <select id="edit-task-subteam" class="text-xs border rounded p-1">
                                <option>Drivetrain</option>
                                <option>Suspension</option>
                                <option>Accumulator</option>
                                <option>Cockpit</option>
                                <option>General</option>
                            </select>
                            <input type="text" id="edit-task-id"
                                class="text-xs border-b border-stone-300 w-24 bg-transparent" placeholder="ID">
                        </div>
                    </div>
                    <button type="button"
                        class="bg-white rounded-md text-stone-400 hover:text-stone-500 focus:outline-none ml-4"
                        onclick="app.closeModal()">
                        <span class="text-2xl font-bold">&times;</span>
                    </button>
                </div>

                <!-- Modal Body -->
                <div class="px-4 py-5 sm:p-6 space-y-6">

                    <!-- READ MODE CONTENT -->
                    <div id="modal-content-read">

                        <!-- NEW STATUS BAR -->
                        <div
                            class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 bg-stone-50 p-4 rounded-lg mb-6 border border-stone-200">
                            <div class="flex items-center gap-3">
                                <span class="text-xs font-bold text-stone-400 uppercase tracking-wide">Status</span>
                                <div id="modal-status-container">
                                    <!-- Populated by JS: Either a Badge or a Select Dropdown -->
                                </div>
                            </div>
                            <div id="modal-actions" class="flex gap-2"></div>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <dl class="space-y-3">
                                <div class="flex justify-between border-b border-stone-100 pb-1">
                                    <dt class="text-sm font-medium text-stone-500">Material</dt>
                                    <dd class="text-sm text-stone-900 font-semibold" id="modal-material">-</dd>
                                </div>
                                <div class="flex justify-between border-b border-stone-100 pb-1">
                                    <dt class="text-sm font-medium text-stone-500">Qty</dt>
                                    <dd class="text-sm text-stone-900 font-semibold" id="modal-qty">-</dd>
                                </div>
                                <div class="flex justify-between border-b border-stone-100 pb-1">
                                    <dt class="text-sm font-medium text-stone-500">Tool/Process</dt>
                                    <dd class="text-sm text-stone-900 font-semibold" id="modal-tool">-</dd>
                                </div>
                                <div class="flex justify-between border-b border-stone-100 pb-1">
                                    <dt class="text-sm font-medium text-stone-500">Owner</dt>
                                    <dd class="text-sm text-stone-900 font-semibold" id="modal-owner">-</dd>
                                </div>
                            </dl>
                            <div id="drawing-section"
                                class="bg-stone-100 rounded-lg p-4 flex flex-col justify-center items-center text-center border-2 border-dashed border-stone-300">
                                <span class="text-4xl mb-2">&#128196;</span>
                                <h4 class="text-sm font-bold text-stone-700">Drawing</h4>
                                <button id="view-pdf-btn" onclick="app.viewPDF()" style="display: none;"
                                    class="mt-2 bg-white border border-stone-300 text-stone-700 hover:bg-stone-50 px-3 py-1 rounded text-xs shadow-sm">View
                                    PDF</button>
                                <p id="no-pdf-msg" class="mt-2 text-xs text-stone-400">No drawing uploaded</p>
                            </div>
                        </div>
                        <div class="mt-6">
                            <h4 class="text-xs font-bold text-stone-400 uppercase tracking-wider mb-2">Notes</h4>
                            <p id="modal-notes" class="text-sm text-stone-600 bg-stone-50 p-3 rounded-md italic">No
                                notes.</p>
                        </div>
                    </div>

                    <!-- EDIT MODE CONTENT -->
                    <div id="modal-content-edit" class="hidden space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-stone-500 uppercase">Owner</label>
                                <select id="edit-task-owner" class="w-full border rounded p-2 mt-1"></select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-stone-500 uppercase">Status</label>
                                <select id="edit-task-status" class="w-full border rounded p-2 mt-1">
                                    <option>Not Started</option>
                                    <option>In Progress</option>
                                    <option>Completed</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-stone-500 uppercase">Material</label>
                                <input type="text" id="edit-task-material" class="w-full border rounded p-2 mt-1">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-stone-500 uppercase">Tool</label>
                                <input type="text" id="edit-task-tool" class="w-full border rounded p-2 mt-1">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-stone-500 uppercase">Quantity</label>
                                <input type="number" id="edit-task-qty" class="w-full border rounded p-2 mt-1">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-stone-500 uppercase">Google Drive
                                    Link</label>
                                <input type="url" id="edit-task-link" placeholder="https://drive.google.com/..."
                                    class="w-full border rounded p-2 mt-1 text-sm">
                                <p class="text-xs text-stone-400 mt-1">Paste the shareable Google Drive link to your PDF
                                </p>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-stone-500 uppercase">Notes</label>
                            <textarea id="edit-task-notes" class="w-full border rounded p-2 mt-1 h-24"></textarea>
                        </div>
                        <div class="flex justify-between pt-4 border-t border-stone-100">
                            <button onclick="app.deleteTask()"
                                class="text-red-500 hover:text-red-700 text-sm font-bold flex items-center gap-1">
                                <span>&#128465;</span> Delete Task
                            </button>
                            <div class="flex gap-3">
                                <button onclick="app.toggleEditMode(false)"
                                    class="text-stone-500 hover:text-stone-700 text-sm font-medium">Cancel</button>
                                <button onclick="app.saveTaskEdit()"
                                    class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm font-medium shadow-sm">Save
                                    Changes</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- ================== JAVASCRIPT ================== -->
    <script>
        // --- FIREBASE CONFIGURATION ---
        // Config is loaded from firebase-config.js
        if (typeof firebaseConfig === 'undefined') {
            alert("Error: firebase-config.js not found!\n\nPlease copy 'firebase-config.example.js' to 'firebase-config.js' and add your API credentials.");
            throw new Error("firebaseConfig is not defined");
        }

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const app = {
            currentUser: null,
            currentRole: 'member',
            tasks: [], // Will be populated by Firestore
            members: [], // {name, subteam}
            charts: {},
            currentEditingId: null,

            // Loading Flags
            isTasksLoaded: false,
            isMembersLoaded: false,

            init: () => {
                // Restore Session
                const savedUser = localStorage.getItem('fsae_user');
                const savedRole = localStorage.getItem('fsae_role');
                if (savedUser) {
                    app.currentUser = savedUser;
                    app.currentRole = savedRole || 'member';
                }

                // Real-time listener for Tasks
                db.collection("tasks").onSnapshot((querySnapshot) => {
                    const tasks = [];
                    querySnapshot.forEach((doc) => {
                        tasks.push({ id: doc.id, ...doc.data() });
                    });

                    app.isTasksLoaded = true;

                    // SEEDING LOGIC
                    if (tasks.length === 0 && !app.hasSeeded) {
                        app.hasSeeded = true;
                        if (confirm("Database is empty. Initialize with sample data?")) {
                            app.seedDatabase();
                        } else {
                            app.allowManualLogin();
                        }
                    } else {
                        app.tasks = tasks;
                        // Determine if we are ready to render (wait for members too)
                        app.checkReady();
                    }
                }, (error) => {
                    console.error("Error getting tasks: ", error);
                    if (error.code === 'permission-denied') {
                        alert("Firebase Permission Denied.\nMake sure you created the database in 'Test Mode'.");
                    }
                });

                // Real-time listener for Members
                db.collection("members").onSnapshot((querySnapshot) => {
                    const members = [];
                    querySnapshot.forEach((doc) => {
                        members.push({ id: doc.id, ...doc.data() });
                    });
                    app.firestoreMembers = members;
                    app.isMembersLoaded = true;
                    app.checkReady();
                });
            },

            firestoreMembers: [],
            hasSeeded: false, // Flag to track seeding attempt

            checkReady: () => {
                // Prevent incomplete renders
                if (!app.isTasksLoaded || !app.isMembersLoaded) return;

                try {
                    // Combine stored members with legacy task owners
                    app.updateMembersList();

                    // Refresh UI
                    if (app.currentUser) {
                        // Re-login logic to update UI state
                        document.getElementById('login-view').classList.add('hidden');
                        document.getElementById('app-shell').classList.remove('hidden');
                        document.getElementById('user-display-name').textContent = app.currentUser;

                        // Robust Find
                        // Robust Find
                        const userObj = app.members.find(m => m.name.toLowerCase() === app.currentUser.toLowerCase());
                        const subteam = userObj ? userObj.subteam.trim() : 'General';

                        // DETERMINE LEAD SCOPE
                        const isPM = app.currentUser.toLowerCase() === 'jake hamilton' || app.currentUser.toLowerCase() === 'alyssa aranda';

                        if (isPM) {
                            app.leadScope = 'All';
                        } else if (app.currentRole === 'lead' && userObj) {
                            app.leadScope = subteam;
                        } else {
                            app.leadScope = null; // Member
                        }

                        document.getElementById('user-display-subteam').textContent = app.currentRole === 'lead' ? (app.leadScope === 'All' ? 'Project Manager' : `${subteam} Lead`) : subteam;
                        document.getElementById('nav-portal-label').textContent = app.currentRole === 'lead' ? "Lead Portal" : "Member Portal";

                        app.populateUserSelect();
                        // Restore dropdown value
                        const userInput = document.getElementById('user-input');
                        if (userInput) userInput.value = app.currentUser;

                        if (app.currentRole === 'lead') {
                            app.renderLeadDashboard();
                            app.renderManageTab(); // Update Manage Tab data even if hidden (fixes refresh issue)
                        } else {
                            app.renderMemberDashboard();
                        }
                    } else {
                        app.populateUserSelect();
                    }
                } catch (err) {
                    console.error("Error in checkReady/Render:", err);
                    document.getElementById('login-view').classList.add('hidden');
                    document.getElementById('app-shell').classList.remove('hidden');
                    alert("A rendering error occurred: " + err.message + "\n\nPlease check the console for details.");
                }
            },

            // ... (skip unrelated)

            // --- LEAD DASHBOARD ---
            switchLeadTab: (tabName) => {
                const overviewTab = document.getElementById('tab-overview');
                const manageTab = document.getElementById('tab-manage');
                const contentOverview = document.getElementById('lead-content-overview');
                const contentManage = document.getElementById('lead-content-manage');

                if (tabName === 'overview') {
                    overviewTab.className = "tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm";
                    manageTab.className = "tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm";
                    contentOverview.classList.remove('hidden');
                    contentManage.classList.add('hidden');
                    app.renderLeadDashboard(); // Refresh charts
                } else {
                    manageTab.className = "tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm";
                    overviewTab.className = "tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm";
                    contentManage.classList.remove('hidden');
                    contentOverview.classList.add('hidden');
                    app.renderManageTab();

                    // Filter tasks for the Workload Chart in Manage Tab
                    let tasksToChart = app.tasks;
                    const scope = app.leadScope ? app.leadScope.trim() : null;
                    if (scope && scope !== 'All') {
                        // Aggressive filtering: handle potential whitespace/case in task data
                        tasksToChart = app.tasks.filter(t => t.subteam && t.subteam.trim().toLowerCase() === scope.toLowerCase());
                    }
                    app.renderCharts(tasksToChart);
                }
            },

            renderLeadDashboard: () => {
                document.getElementById('member-dashboard').classList.add('hidden');
                document.getElementById('lead-dashboard').classList.remove('hidden');

                const filterSelect = document.getElementById('lead-filter-subteam');

                // RESTRICT FILTER FOR SUBTEAM LEADS
                if (app.leadScope && app.leadScope !== 'All') {
                    filterSelect.value = app.leadScope;
                    filterSelect.disabled = true;
                } else {
                    filterSelect.disabled = false;
                    // preserve existing selection or default to All
                }

                const filter = filterSelect.value;
                const filteredTasks = filter === 'All' ? app.tasks : app.tasks.filter(t => t.subteam === filter);

                const tbody = document.getElementById('lead-table-body');
                tbody.innerHTML = '';
                filteredTasks.forEach(task => {
                    // ... (rendering code same as before, just ensuring filteredTasks is correct)
                    const row = document.createElement('tr');
                    row.className = "hover:bg-stone-50 transition-colors cursor-pointer";
                    row.onclick = () => app.openModal(task.id);
                    const statusClass = task.status === 'Completed' ? 'status-pill-completed' : (task.status === 'In Progress' ? 'status-pill-progress' : 'status-pill-todo');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-stone-900">${task.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${task.owner || '<span class="italic text-stone-300">Unassigned</span>'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${task.subteam}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full border ${statusClass}">${task.status}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><span class="text-stone-400 hover:text-red-600">View</span></td>
                    `;
                    tbody.appendChild(row);
                });
                app.renderCharts(filteredTasks);
            },

            renderManageTab: () => {
                const list = document.getElementById('member-roster-list');
                list.innerHTML = '';

                // FILTER MEMBERS
                let membersToShow = app.members;
                if (app.leadScope && app.leadScope !== 'All') {
                    membersToShow = app.members.filter(m => m.subteam === app.leadScope);

                    // Also lock the add member dropdown
                    const addSelect = document.getElementById('new-member-subteam');
                    if (addSelect) {
                        addSelect.value = app.leadScope;
                        addSelect.disabled = true;
                    }
                } else {
                    const addSelect = document.getElementById('new-member-subteam');
                    if (addSelect) addSelect.disabled = false;
                }

                membersToShow.forEach(m => {
                    const item = document.createElement('div');
                    item.className = "px-4 py-3 bg-white flex justify-between items-center group/item";

                    const isLead = m.role === 'lead';
                    const leadBadge = isLead ? '<span class="ml-2 text-[10px] bg-red-100 text-red-700 px-2 py-0.5 rounded-full uppercase font-bold tracking-wider">Lead</span>' : '';

                    item.innerHTML = `
                        <div>
                            <div class="flex items-center">
                                <p class="text-sm font-medium text-stone-900">${m.name}</p>
                                ${leadBadge}
                            </div>
                            <p class="text-xs text-stone-500">${m.subteam}</p>
                        </div>
                        <div class="flex gap-2 opacity-0 group-hover/item:opacity-100 transition-opacity">
                             <button onclick="app.toggleMemberRole('${m.name}')" class="text-xs font-semibold ${isLead ? 'text-stone-400 hover:text-stone-600' : 'text-stone-400 hover:text-red-600'}">
                                ${isLead ? 'Demote' : 'Make Lead'}
                             </button>
                             <div class="w-px bg-stone-200"></div>
                             <button onclick="app.removeMember('${m.name}')" class="text-stone-300 hover:text-red-600 text-xs font-semibold">Remove</button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            },

            // skip unrelated methods...

            deleteTask: () => {
                const id = app.currentEditingId;
                if (!id) return;

                db.collection("tasks").doc(id).delete().then(() => {
                    // OPTIMISTIC UPDATE: Remove locally immediately to prevent lag/gray screen
                    app.tasks = app.tasks.filter(t => t.id !== id);
                    app.closeModal();
                    app.checkReady(); // Re-render
                }).catch(err => console.error(err));
            },

            seedDatabase: () => {
                const sampleData = [
                    { name: "Left Eccentric Tensioner", subteam: "Drivetrain", qty: 1, material: "6061 AL", owner: "Ben", tool: "CNC Mill", status: "Completed", notes: "Design Locked" },
                    { name: "Driven Sprocket", subteam: "Drivetrain", qty: 1, material: "1018 Steel", owner: "Rowan", tool: "Waterjet", status: "Completed", notes: "Connects to sprocket mount" },
                    { name: "Enclosure Floor", subteam: "Accumulator", qty: 1, material: "AL 5052", owner: "Kai-Xing", tool: "OSH Cut", status: "Completed", notes: "Actual bottom of enclosure" },
                    { name: "Nostril Enclosure", subteam: "Cockpit", qty: 1, material: "Polycarbonate", owner: "Mehmet", tool: "Waterjet", status: "Completed", notes: "Bottom of nostril" },
                    { name: "Front Upper A-Arm", subteam: "Suspension", qty: 2, material: "4130 Steel", owner: "Addison", tool: "Weld", status: "Completed", notes: "Jig required" },
                    { name: "Steering Rod", subteam: "Suspension", qty: 2, material: "4130 Steel", owner: "Aditi", tool: "Weld+Mill", status: "In Progress", notes: "Size to fit" },
                    { name: "Clean Shop Floor", subteam: "General", qty: 1, material: "N/A", owner: "Team", tool: "Broom", status: "Not Started", notes: "Weekly cleaning" }
                ];

                const batch = db.batch();
                sampleData.forEach(data => {
                    const docRef = db.collection("tasks").doc();
                    batch.set(docRef, data);
                });

                // Also seed members from this data so the roster isn't empty
                const uniqueOwners = [...new Set(sampleData.map(t => t.owner))];
                uniqueOwners.forEach(owner => {
                    const docRef = db.collection("members").doc();
                    const task = sampleData.find(t => t.owner === owner);
                    batch.set(docRef, { name: owner, subteam: task.subteam });
                });

                batch.commit().then(() => {
                    console.log("Database seeded!");
                }).catch(err => console.error("Error seeding: ", err));
            },

            allowManualLogin: () => {
                // If user declines seeding, add a temporary 'Admin' user so they aren't locked out
                app.members = [{ name: "Admin", subteam: "General" }];
                app.populateUserSelect();
            },

            updateMembersList: () => {
                // 1. Get members from Firestore Collection
                let members = [...app.firestoreMembers];

                // 2. Add any legacy owners from tasks that aren't in the member list
                // (This ensures old data still works if we didn't migrate members properly)
                const taskOwners = [...new Set(app.tasks.map(t => t.owner).filter(Boolean))];
                taskOwners.forEach(ownerName => {
                    if (!members.find(m => m.name === ownerName)) {
                        const task = app.tasks.find(t => t.owner === ownerName);
                        members.push({ name: ownerName, subteam: task ? task.subteam : 'General', isLegacy: true });
                    }
                });

                app.members = members;
            },

            populateUserSelect: () => {
                const dataList = document.getElementById('user-list');
                const cleanMembers = app.members.sort((a, b) => a.name.localeCompare(b.name));

                dataList.innerHTML = '';
                cleanMembers.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.name;
                    dataList.appendChild(option);
                });
            },



            // --- AUTH ---
            login: () => {
                const userInput = document.getElementById('user-input'); // Changed from select
                const roleRadios = document.getElementsByName('role');
                const selectedUserRaw = userInput.value.trim();

                if (!selectedUserRaw) return alert("Please enter a team member name.");

                // Normalize User Name
                const matchedMember = app.members.find(m => m.name.toLowerCase() === selectedUserRaw.toLowerCase());
                const selectedUser = matchedMember ? matchedMember.name : selectedUserRaw; // Auto-correct case

                app.currentUser = selectedUser;

                // Clean up duplicated code
                // (Empty placeholder to remove lines)

                // LEAD LOGIC: Check name for special PM access or DB role
                const memberRecord = matchedMember || app.members.find(m => m.name === selectedUser);

                const isPM = selectedUser.toLowerCase() === 'jake hamilton' || selectedUser.toLowerCase() === 'alyssa aranda';

                if (isPM) {
                    app.currentRole = 'lead';
                } else if (memberRecord && memberRecord.role === 'lead') {
                    app.currentRole = 'lead';
                } else {
                    app.currentRole = 'member';
                }

                // DETERMINE LEAD SCOPE (Immediate)
                if (isPM) {
                    app.leadScope = 'All';
                } else if (app.currentRole === 'lead' && memberRecord) {
                    app.leadScope = memberRecord.subteam;
                } else {
                    app.leadScope = null;
                }

                // Save Session
                localStorage.setItem('fsae_user', app.currentUser);
                localStorage.setItem('fsae_role', app.currentRole);

                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('app-shell').classList.remove('hidden');
                document.getElementById('user-display-name').textContent = app.currentUser;

                const userObj = matchedMember || { subteam: 'General' };
                const subteam = userObj.subteam;
                document.getElementById('user-display-subteam').textContent = app.currentRole === 'lead' ? (app.leadScope === 'All' ? 'Project Manager' : `${subteam} Lead`) : subteam;
                document.getElementById('nav-portal-label').textContent = app.currentRole === 'lead' ? "Lead Portal" : "Member Portal";

                // Ensure user is in list for dropdowns if they are new
                if (app.currentRole === 'lead') {
                    app.renderLeadDashboard();
                    app.renderManageTab();
                } else {
                    app.renderMemberDashboard();
                }
            },

            logout: () => {
                localStorage.removeItem('fsae_user');
                localStorage.removeItem('fsae_role');
                location.reload();
            },

            // --- MEMBER DASHBOARD ---
            renderMemberDashboard: () => {
                document.getElementById('member-dashboard').classList.remove('hidden');
                document.getElementById('lead-dashboard').classList.add('hidden');

                const myTasks = app.tasks.filter(t => t.owner === app.currentUser);
                const poolTasks = app.tasks.filter(t => !t.owner);

                // Stats
                const completed = myTasks.filter(t => t.status === 'Completed').length;
                const total = myTasks.length;
                const percent = total === 0 ? 0 : Math.round((completed / total) * 100);

                document.getElementById('member-progress-bar').style.width = `${percent}%`;
                document.getElementById('member-progress-text').textContent = `${completed} / ${total} Tasks Done`;
                document.getElementById('member-pending-count').textContent = total - completed;

                // Lists
                const tasksContainer = document.getElementById('my-tasks-list');
                tasksContainer.innerHTML = '';
                if (myTasks.length === 0) document.getElementById('my-tasks-empty').classList.remove('hidden');
                else {
                    document.getElementById('my-tasks-empty').classList.add('hidden');
                    myTasks.forEach(task => tasksContainer.appendChild(app.createTaskCard(task, false)));
                }

                const poolContainer = document.getElementById('pool-tasks-list');
                poolContainer.innerHTML = '';
                poolTasks.forEach(task => poolContainer.appendChild(app.createTaskCard(task, true)));
            },

            createTaskCard: (task, isPool) => {
                const card = document.createElement('div');
                const statusColor = task.status === 'Completed' ? 'bg-emerald-500' : (task.status === 'In Progress' ? 'bg-amber-500' : 'bg-stone-300');
                const borderClass = isPool ? 'border-l-4 border-l-stone-400' : (task.status === 'Completed' ? 'border-l-4 border-l-emerald-500' : (task.status === 'In Progress' ? 'border-l-4 border-l-amber-500' : 'border-l-4 border-l-stone-300'));

                card.className = `p-4 rounded-lg border border-stone-200 bg-white shadow-sm hover:shadow-md transition-shadow cursor-pointer flex justify-between items-center group ${borderClass}`;
                card.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs font-bold text-stone-400 uppercase">${task.subteam}</span>
                            ${!isPool ? `<span class="w-2 h-2 rounded-full ${statusColor}"></span>` : ''}
                        </div>
                        <h4 class="text-stone-800 font-semibold group-hover:text-red-600 transition-colors">${task.name}</h4>
                        <p class="text-xs text-stone-500 mt-1">ID: ${task.id || 'Pending'}</p>
                    </div>
                    <div>${isPool ? `<button class="text-xs bg-stone-100 hover:bg-stone-200 text-stone-600 px-3 py-1 rounded font-medium transition-colors" onclick="event.stopPropagation(); app.pickupTask('${task.id}')">Pick Up</button>` : `<button class="text-xs bg-red-100 hover:bg-red-200 text-red-600 px-3 py-1 rounded font-medium transition-colors" onclick="event.stopPropagation(); app.dropTask('${task.id}')">Drop</button>`}</div>
                `;
                card.onclick = (e) => { if (e.target.tagName !== 'BUTTON') app.openModal(task.id); };
                return card;
            },

            // --- LEAD DASHBOARD ---
            switchLeadTab: (tabName) => {
                const overviewTab = document.getElementById('tab-overview');
                const manageTab = document.getElementById('tab-manage');
                const contentOverview = document.getElementById('lead-content-overview');
                const contentManage = document.getElementById('lead-content-manage');

                if (tabName === 'overview') {
                    overviewTab.className = "tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm";
                    manageTab.className = "tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm";
                    contentOverview.classList.remove('hidden');
                    contentManage.classList.add('hidden');
                    app.renderLeadDashboard(); // Refresh charts
                } else {
                    manageTab.className = "tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm";
                    overviewTab.className = "tab-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm";
                    contentManage.classList.remove('hidden');
                    contentOverview.classList.add('hidden');
                    app.renderManageTab();

                    // Filter tasks for the Workload Chart in Manage Tab
                    let tasksToChart = app.tasks;
                    const scope = app.leadScope ? app.leadScope.trim() : null;
                    if (scope && scope !== 'All') {
                        // Aggressive filtering: handle potential whitespace/case in task data
                        tasksToChart = app.tasks.filter(t => t.subteam && t.subteam.trim().toLowerCase() === scope.toLowerCase());
                    }
                    app.renderCharts(tasksToChart);
                }
            },

            renderLeadDashboard: () => {
                document.getElementById('member-dashboard').classList.add('hidden');
                document.getElementById('lead-dashboard').classList.remove('hidden');

                const filterSelect = document.getElementById('lead-filter-subteam');
                const scope = app.leadScope ? app.leadScope.trim() : null;

                // RESTRICT FILTER FOR SUBTEAM LEADS
                if (scope && scope !== 'All') {
                    filterSelect.value = scope;
                    filterSelect.disabled = true;
                } else {
                    filterSelect.disabled = false;
                }

                const filter = filterSelect.value;
                // Aggressive filtering
                let filteredTasks = app.tasks;
                if (filter !== 'All') {
                    filteredTasks = app.tasks.filter(t => t.subteam && t.subteam.trim().toLowerCase() === filter.toLowerCase());
                }

                const tbody = document.getElementById('lead-table-body');
                tbody.innerHTML = '';
                filteredTasks.forEach(task => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-stone-50 transition-colors cursor-pointer";
                    row.onclick = () => app.openModal(task.id);
                    const statusClass = task.status === 'Completed' ? 'status-pill-completed' : (task.status === 'In Progress' ? 'status-pill-progress' : 'status-pill-todo');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-stone-900">${task.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${task.owner || '<span class="italic text-stone-300">Unassigned</span>'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${task.subteam}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full border ${statusClass}">${task.status}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><span class="text-stone-400 hover:text-red-600">View</span></td>
                    `;
                    tbody.appendChild(row);
                });
                app.renderCharts(filteredTasks);
            },

            renderManageTab: () => {
                const list = document.getElementById('member-roster-list');
                list.innerHTML = '';

                // FILTER MEMBERS
                // Trim to ensure matches against database whitespace
                let membersToShow = app.members;
                const scope = app.leadScope ? app.leadScope.trim() : null;

                if (scope && scope !== 'All') {
                    membersToShow = app.members.filter(m => m.subteam.trim() === scope);

                    // Lock Add Member Dropdown
                    const addSelect = document.getElementById('new-member-subteam');
                    if (addSelect) {
                        addSelect.value = scope;
                        addSelect.disabled = true;
                    }
                } else {
                    const addSelect = document.getElementById('new-member-subteam');
                    if (addSelect) addSelect.disabled = false;
                }

                membersToShow.forEach(m => {
                    const item = document.createElement('div');
                    item.className = "px-4 py-3 bg-white flex justify-between items-center group/item";

                    const isLead = m.role === 'lead';
                    const leadBadge = isLead ? '<span class="ml-2 text-[10px] bg-red-100 text-red-700 px-2 py-0.5 rounded-full uppercase font-bold tracking-wider">Lead</span>' : '';

                    item.innerHTML = `
                        <div>
                            <div class="flex items-center">
                                <p class="text-sm font-medium text-stone-900">${m.name}</p>
                                ${leadBadge}
                            </div>
                            <p class="text-xs text-stone-500">${m.subteam}</p>
                        </div>
                        <div class="flex gap-2 opacity-0 group-hover/item:opacity-100 transition-opacity">
                             <button onclick="app.toggleMemberRole('${m.name}')" class="text-xs font-semibold ${isLead ? 'text-stone-400 hover:text-stone-600' : 'text-stone-400 hover:text-red-600'}">
                                ${isLead ? 'Demote' : 'Make Lead'}
                             </button>
                             <div class="w-px bg-stone-200"></div>
                             <button onclick="app.removeMember('${m.name}')" class="text-stone-300 hover:text-red-600 text-xs font-semibold">Remove</button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            },

            toggleMemberRole: (name) => {
                const member = app.firestoreMembers.find(m => m.name === name);
                if (member) {
                    const newRole = member.role === 'lead' ? 'member' : 'lead';
                    db.collection("members").doc(member.id).update({ role: newRole }).catch(err => console.error(err));
                } else {
                    alert("Cannot edit rule for legacy/auto-generated member.");
                }
            },

            renderCharts: (tasks) => {
                const statusCounts = { 'Completed': 0, 'In Progress': 0, 'Not Started': 0 };
                tasks.forEach(t => statusCounts[t.status]++);

                const ctxStatus = document.getElementById('teamStatusChart').getContext('2d');
                if (app.charts.status) app.charts.status.destroy();
                app.charts.status = new Chart(ctxStatus, {
                    type: 'doughnut',
                    data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#10b981', '#f59e0b', '#e7e5e4'], borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });

                const workload = {};
                tasks.forEach(t => { if (t.owner) workload[t.owner] = (workload[t.owner] || 0) + 1; });

                let sortedOwners = Object.entries(workload).sort((a, b) => b[1] - a[1]);

                // STRICT FILTER: Only show members belonging to the current scope
                const scope = app.leadScope ? app.leadScope.trim() : null;
                if (scope && scope !== 'All') {
                    sortedOwners = sortedOwners.filter(([name, count]) => {
                        const m = app.members.find(mem => mem.name === name);
                        return m && m.subteam.trim().toLowerCase() === scope.toLowerCase();
                    });
                }

                sortedOwners = sortedOwners.slice(0, 8);

                const ctxWorkload = document.getElementById('memberWorkloadChart').getContext('2d');
                if (app.charts.workload) app.charts.workload.destroy();
                app.charts.workload = new Chart(ctxWorkload, {
                    type: 'bar',
                    data: { labels: sortedOwners.map(x => x[0]), datasets: [{ label: 'Tasks', data: sortedOwners.map(x => x[1]), backgroundColor: '#44403c', borderRadius: 4 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } }
                });
            },

            // --- ACTIONS ---
            pickupTask: (id) => {
                // UPDATE FIRESTORE
                db.collection("tasks").doc(id).update({
                    owner: app.currentUser,
                    status: "Not Started"
                }).catch(err => console.error(err));
                // No need to manually update local state, onSnapshot will handle it
            },

            dropTask: (id) => {
                // Set owner to empty to move task back to pool
                db.collection("tasks").doc(id).update({
                    owner: "",
                    status: "Not Started"
                }).catch(err => console.error(err));
            },

            updateStatus: (id, newStatus) => {
                db.collection("tasks").doc(id).update({
                    status: newStatus
                }).catch(err => console.error(err));
            },

            deleteTask: () => {
                const id = app.currentEditingId;
                if (!id) return;
                if (confirm("Are you sure you want to delete this task? This cannot be undone.")) {
                    db.collection("tasks").doc(id).delete().then(() => {
                        app.closeModal();
                    }).catch(err => console.error(err));
                }
            },

            addMember: () => {
                const nameInput = document.getElementById('new-member-name');
                const teamSelect = document.getElementById('new-member-subteam');
                if (!nameInput.value) return;

                // Add to Firestore
                db.collection("members").add({
                    name: nameInput.value,
                    subteam: teamSelect.value
                }).then(() => {
                    nameInput.value = '';
                    // onSnapshot will handle UI update
                }).catch(err => console.error("Error adding member: ", err));
            },

            removeMember: (name) => {
                if (confirm(`Remove ${name}?`)) {
                    // Find member ID to delete
                    const member = app.firestoreMembers.find(m => m.name === name);
                    if (member) {
                        db.collection("members").doc(member.id).delete().catch(err => console.error(err));
                    } else {
                        alert("Cannot remove this member (likely derived from a task owner).");
                    }
                }
            },

            createNewTask: () => {
                // Default subteam based on lead scope
                const scope = app.leadScope ? app.leadScope.trim() : null;
                const defaultSubteam = (scope && scope !== 'All') ? scope : 'General';

                const newTask = {
                    name: "New Task",
                    subteam: defaultSubteam,
                    owner: app.currentUser || "", // Default to creator
                    status: "Not Started",
                    material: "",
                    tool: "",
                    qty: 1,
                    notes: "",
                    drawingUrl: "" // New field
                };

                db.collection("tasks").add(newTask).then((docRef) => {
                    app.openModal(docRef.id);
                    app.toggleEditMode(true);
                }).catch(err => console.error("Error adding task: ", err));
            },

            saveTaskEdit: () => {
                const id = document.getElementById('edit-task-id').value; // Might be hidden or we use currentEditingId
                // We don't have an input for ID in the edit form usually (it was read only in read mode), 
                // but let's see. In the original code `createNewTask` used a random ID.
                // Here we use the firestore ID.

                const targetId = app.currentEditingId;
                if (!targetId) return;

                const updates = {
                    name: document.getElementById('edit-task-name').value,
                    subteam: document.getElementById('edit-task-subteam').value,
                    owner: document.getElementById('edit-task-owner').value,
                    status: document.getElementById('edit-task-status').value,
                    material: document.getElementById('edit-task-material').value,
                    tool: document.getElementById('edit-task-tool').value,
                    qty: Number(document.getElementById('edit-task-qty').value),
                    notes: document.getElementById('edit-task-notes').value,
                    drawingUrl: document.getElementById('edit-task-link').value
                };

                db.collection("tasks").doc(targetId).update(updates).then(() => {
                    app.toggleEditMode(false);
                }).catch(err => console.error(err));
            },

            // --- MODAL ---
            openModal: (taskId) => {
                const task = app.tasks.find(t => t.id === taskId);
                if (!task) return;
                app.currentEditingId = taskId;

                // Reset View
                app.toggleEditMode(false);

                // Populate Read View
                document.getElementById('modal-title').textContent = task.name;
                document.getElementById('modal-subteam').textContent = `${task.subteam}`;
                document.getElementById('modal-material').textContent = task.material;
                document.getElementById('modal-qty').textContent = task.qty;
                document.getElementById('modal-tool').textContent = task.tool;
                document.getElementById('modal-owner').textContent = task.owner || "Unassigned";
                document.getElementById('modal-notes').textContent = task.notes || "No notes.";

                // Update PDF display
                const viewPdfBtn = document.getElementById('view-pdf-btn');
                const noPdfMsg = document.getElementById('no-pdf-msg');
                if (task.drawingUrl) {
                    viewPdfBtn.style.display = 'inline-block';
                    noPdfMsg.style.display = 'none';
                } else {
                    viewPdfBtn.style.display = 'none';
                    noPdfMsg.style.display = 'block';
                }

                // --- STATUS PILL LOGIC ---
                const statusContainer = document.getElementById('modal-status-container');
                const isOwner = task.owner === app.currentUser;
                const isLead = app.currentRole === 'lead';

                if (isOwner || isLead) {
                    // Render interactive SELECT dropdown
                    statusContainer.innerHTML = `
                        <select onchange="app.updateStatus('${task.id}', this.value)" class="select-pill transition-colors shadow-sm">
                            <option value="Not Started" ${task.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
                            <option value="In Progress" ${task.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                            <option value="Completed" ${task.status === 'Completed' ? 'selected' : ''}>Completed</option>
                        </select>
                    `;
                    // Apply initial color style
                    app.styleSelect(statusContainer.querySelector('select'), task.status);
                } else {
                    // Render Read-Only Badge
                    const badgeClass = task.status === 'Completed' ? 'bg-emerald-100 text-emerald-800' : (task.status === 'In Progress' ? 'bg-amber-100 text-amber-800' : 'bg-stone-100 text-stone-600');
                    statusContainer.innerHTML = `<span class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-bold uppercase tracking-wide ${badgeClass}">${task.status}</span>`;
                }

                // DRAWING BUTTON LOGIC is now handled by the updated openModal code above



                // Show modal
                document.getElementById('task-modal').classList.remove('hidden');
                document.body.classList.add('modal-active');

                // Set Up Actions
                // Set Up Actions
                const actionsContainer = document.getElementById('modal-actions');
                actionsContainer.innerHTML = '';
                if (isLead || isOwner) {
                    // Edit Button
                    const editBtn = document.createElement('button');
                    editBtn.className = "text-stone-400 hover:text-stone-600 mr-2";
                    editBtn.title = "Edit Task";
                    editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/></svg>`;
                    editBtn.onclick = () => app.toggleEditMode(true);
                    actionsContainer.appendChild(editBtn);

                    // Quick Delete Button (Trash)
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = "text-stone-300 hover:text-red-500";
                    deleteBtn.title = "Delete Task";
                    deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6Z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1ZM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118ZM2.5 3h11V2h-11v1Z"/></svg>`;
                    deleteBtn.onclick = () => {
                        if (confirm("Are you sure you want to delete this task?")) {
                            app.currentEditingId = task.id; // ensure ID is set
                            app.deleteTask();
                        }
                    };
                    actionsContainer.appendChild(deleteBtn);
                }
            },

            closeModal: () => {
                document.getElementById('task-modal').classList.add('hidden');
                document.body.classList.remove('modal-active');
            },

            toggleEditMode: (isEdit) => {
                const readContent = document.getElementById('modal-content-read');
                const editContent = document.getElementById('modal-content-edit');
                const headerRead = document.getElementById('modal-header-read');
                const headerEdit = document.getElementById('modal-header-edit');

                if (isEdit) {
                    readContent.classList.add('hidden');
                    editContent.classList.remove('hidden');
                    headerRead.classList.add('hidden');
                    headerEdit.classList.remove('hidden');

                    const task = app.tasks.find(t => t.id === app.currentEditingId);
                    if (task) {
                        document.getElementById('edit-task-name').value = task.name;

                        const subteamSelect = document.getElementById('edit-task-subteam');
                        subteamSelect.value = task.subteam;

                        // LOCK SUBTEAM FOR RESTRICTED LEADS
                        const scope = app.leadScope ? app.leadScope.trim() : null;
                        if (scope && scope !== 'All') {
                            subteamSelect.disabled = true;
                        } else {
                            subteamSelect.disabled = false;
                        }

                        // Populate owner select
                        const ownerSelect = document.getElementById('edit-task-owner');
                        ownerSelect.innerHTML = '<option value="">-- Unassigned --</option>';
                        app.members.forEach(m => {
                            const opt = document.createElement('option');
                            opt.value = m.name;
                            opt.textContent = m.name;
                            if (m.name === task.owner) opt.selected = true;
                            ownerSelect.appendChild(opt);
                        });

                        document.getElementById('edit-task-status').value = task.status;
                        document.getElementById('edit-task-material').value = task.material;
                        document.getElementById('edit-task-tool').value = task.tool;
                        document.getElementById('edit-task-qty').value = task.qty;
                        document.getElementById('edit-task-notes').value = task.notes;
                        document.getElementById('edit-task-link').value = task.drawingUrl || "";
                    }
                } else {
                    readContent.classList.remove('hidden');
                    editContent.classList.add('hidden');
                    headerRead.classList.remove('hidden');
                    headerEdit.classList.add('hidden');
                }
            },

            viewPDF: () => {
                const task = app.tasks.find(t => t.id === app.currentEditingId);
                if (task && task.drawingUrl) {
                    window.open(task.drawingUrl, '_blank');
                } else {
                    alert('No PDF available for this task.');
                }
            },

            styleSelect: (selectEl, status) => {
                // Reset classes
                selectEl.className = 'select-pill transition-colors shadow-sm';

                if (status === 'Completed') selectEl.classList.add('bg-emerald-100', 'text-emerald-800', 'focus:ring-emerald-400');
                else if (status === 'In Progress') selectEl.classList.add('bg-amber-100', 'text-amber-800', 'focus:ring-amber-400');
                else selectEl.classList.add('bg-stone-100', 'text-stone-600', 'focus:ring-stone-400');
            }
        };

        // Initialize App
        app.init();
    </script>

</body>

</html>